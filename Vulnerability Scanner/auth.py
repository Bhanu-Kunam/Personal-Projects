# auth.py
from bs4 import BeautifulSoup
from session_manager import session # Import the shared session

def login_dvwa(username, password, login_url="http://localhost/login.php"):
    print(f"Attempting to log in to {login_url}...")
    
    # login page to retrieve the user_token
    try:
        response_get = session.get(login_url)
        soup = BeautifulSoup(response_get.text, 'html.parser')
        user_token = soup.find('input', {'name': 'user_token'}).get('value')
        print(f"Retrieved user_token: {user_token}")
    except Exception as e:
        print(f"Failed to get user_token: {e}")
        return False

    # credentials along with the token
    login_payload = {
        'username': username,
        'password': password,
        'user_token': user_token,
        'Login': 'Login'
    }
    
    try:
        response_post = session.post(login_url, data=login_payload)
        
        # Check for successful login
        if "logout.php" in response_post.text or "Welcome" in response_post.text:
            print("Login Sucess")
            return True
        else:
            print("Login Failed")
            return False
    except Exception as e:
        print(f"An exception occurred during login: {e}")
        return False