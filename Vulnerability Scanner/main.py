import URL_Crawler
from auth import login_dvwa
from scanners import (
    scan_xss, 
    scan_error_based_SQLi, 
    scan_boolean_SQLi, 
    scan_union_sqli,
    scan_command_injection,
    scan_stored_xss,        
    scan_csrf,              
    scan_brute_force      
)
from exploit import exploit_table_names_union_sqli, exploit_column_names_union_sqli

# target_url for crawl
URL_Crawler.target_url = "http://localhost/"

# Attempt Login
if login_dvwa("admin", "password"):
    print("Starting crawler on ... " + str(URL_Crawler.target_url) + "\n")
    URL_Crawler.crawl_site(URL_Crawler.target_url)
    print("Crawler Done------" + "\n")

    print("Found " + str(len(URL_Crawler.visited_urls)) + " unique URLs")
    print("Found " + str(len(URL_Crawler.forms_discovered)) + " unique forms" + "\n")

    print("Starting vulnerability scan...")
    for form in URL_Crawler.forms_discovered:
        
        print(f"\n--- Scanning Form: {form['action']} ---")

        # Injection Scans
        scan_xss(form)
        scan_error_based_SQLi(form)
        scan_boolean_SQLi(form)
        scan_command_injection(form)

        # Logic & State Scans
        scan_csrf(form)      
        scan_stored_xss(form)
        
        # Brute Force
        # We check if the action URL contains 'login' or inputs have 'password'
        is_login_form = False
        for input_tag in form["inputs"]:
            if input_tag["type"] == "password":
                is_login_form = True
                break
        
        if is_login_form:
            # Common password list
            scan_brute_force(form, password_list=["123456", "password", "admin", "pass"])

        # SQLi Exploit Chain
        vulnerable_info = scan_union_sqli(form)

        if vulnerable_info:
            # Get table names
            table_names = exploit_table_names_union_sqli(form, vulnerable_info)
            
            # Check if we got tables, then find our target
            if table_names:
                target_table = None
                for name in table_names:
                    # Use .lower() for a case-insensitive match
                    if name.lower() == 'users':
                        target_table = name
                        break # Found it
                
                # If 'users' table found, get its columns
                if target_table:
                    exploit_column_names_union_sqli(form, vulnerable_info, target_table)

    print("\nScan finished")

else:
    print("Login failed. Exiting scanner")